<!doctype html><html lang=en><head><title>AWS Lambda with Terraform ::
masoudkf — Developer Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Overview # Before we begin, let&amp;rsquo;s briefly talk about the concepts and technologies we&amp;rsquo;ll be using.
Cloud # You&amp;rsquo;ve probably heard this before: There&amp;rsquo;s no cloud; it&amp;rsquo;s just someone else&amp;rsquo;s computer. Basically, it&amp;rsquo;s true, although there&amp;rsquo;s more to that. But in a nutshell, instead of buying resources&amp;ndash;such as CPU, Memory, and Storage&amp;ndash;yourself, you rent them from someone else. That someone else is usually a big company. The most popular ones are AWS, Google Cloud, and Azure."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://masoudkarimif.github.io/posts/aws-lambda-with-terraform/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://masoudkarimif.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://masoudkarimif.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://masoudkarimif.github.io/img/favicon.png><link href=/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Lambda with Terraform"><meta name=twitter:description content="We create a Lambda function with Terraform to run a simple Hello World application."><meta property="og:title" content="AWS Lambda with Terraform"><meta property="og:description" content="We create a Lambda function with Terraform to run a simple Hello World application."><meta property="og:type" content="article"><meta property="og:url" content="https://masoudkarimif.github.io/posts/aws-lambda-with-terraform/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-25T00:00:00+00:00"><meta property="og:site_name" content="masoudkf"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFRSZRJSCV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZFRSZRJSCV",{anonymize_ip:!1})}</script></head><body class=light-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>masoudkf</span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><article class=post><h1 class=post-title>AWS Lambda with Terraform</h1><div class=post-meta><time class=post-date>2023-02-25</time>
<span class=post-author>— by masoudkf</span>
<span class=post-read-time>— 13 min read</span></div><span class=post-tags><a href=https://masoudkarimif.github.io/tags/aws/>#aws</a>&nbsp;
<a href=https://masoudkarimif.github.io/tags/lambda/>#lambda</a>&nbsp;
<a href=https://masoudkarimif.github.io/tags/terraform/>#terraform</a>&nbsp;
<a href=https://masoudkarimif.github.io/tags/s3/>#s3</a>&nbsp;</span><div class=post-content><h2 id=overview>Overview
<a href=#overview class=h-anchor aria-hidden=true>#</a></h2><p>Before we begin, let&rsquo;s briefly talk about the concepts and technologies we&rsquo;ll be using.</p><h3 id=cloud>Cloud
<a href=#cloud class=h-anchor aria-hidden=true>#</a></h3><p>You&rsquo;ve probably heard this before: <em>There&rsquo;s no cloud; it&rsquo;s just someone else&rsquo;s computer</em>. Basically, it&rsquo;s true, although there&rsquo;s more to that. But in a nutshell, instead of buying resources&ndash;such as CPU, Memory, and Storage&ndash;yourself, you rent them from someone else. That someone else is usually a big company. The most popular ones are AWS, Google Cloud, and Azure.</p><br><p align=center><img src=https://qph.cf2.quoracdn.net/main-qimg-6a4c094bd9465389d35529b12b6caa77.webp alt=Cloud width=400></p><p align=right><sub>Image Credit: quora.com</sub></p><br><h3 id=aws>AWS
<a href=#aws class=h-anchor aria-hidden=true>#</a></h3><p><a href=https://aws.amazon.com/>Amazon Web Services</a> (AWS) is the first and biggest cloud provider today with more than 34% of the market. AWS has regions all around the world. You can check the whole map <a href=https://aws.amazon.com/about-aws/global-infrastructure/regions_az/>here</a>. It&rsquo;s always recommended to go with the region closest to your business and users as you would be able to offer the best service (faster response time). Some big organizations, such as Netflix, have multiple regions to offer the best service to their customers.</p><p>AWS offers a generous <a href=https://aws.amazon.com/free/>Free Tier</a> for new users for up to 12 months (some services have a free tier forever, not just for 12 months). During this period, you could use a variety (not all!) of services for free, provided you stay below the Free Tier threshold. Some popular services offered by the Free Tier are Lambda, S3, DynamoDB, EC2, and API Gateway. You can create a new account <a href=https://portal.aws.amazon.com/billing/signup#/start/email>here</a>.</p><br><p align=center><img src=http://cdn.statcdn.com/Infographic/images/normal/18819.jpeg alt=AWS width=500></p><p align=right><sub>Image Credit: statista.com</sub></p><br><h3 id=s3>S3
<a href=#s3 class=h-anchor aria-hidden=true>#</a></h3><p>Simple Storage Service (S3) is a cloud-based storage offered by AWS. It&rsquo;s highly available (almost never goes down), scalable (can handle thousands of requests per second), and secure (offers several methods of encryption). You can use S3 to host a data lake (a central location for all your data); host a static website; archive data at a very low cost; and build cloud applications. S3 is the backbone of many services on AWS. One of those services is Lambda&ndash;which we&rsquo;ll be talking about in a bit.</p><p>In order to upload a file to S3, we first need a <strong>bucket</strong>. Buckets are a way of organizing your data on AWS. By default, you can have up to 100 buckets per AWS account. Bucket names <strong>must be unique</strong> worldwide. You can&rsquo;t create an S3 bucket with the same name as somebody else&rsquo;s, even though they&rsquo;re using a different AWS account.</p><br><p align=center><img src=https://miro.medium.com/max/580/1*DHe24MbDHtbkOeIJzxrfdA.png alt=S3 width=400></p><p align=right><sub>Image Credit: AWS</sub></p><br><h3 id=cloudwatch>CloudWatch
<a href=#cloudwatch class=h-anchor aria-hidden=true>#</a></h3><p>CloudWatch is an AWS service that collects and aggregates logs from other services (such as Lambda) on AWS. Logs are the outputs produced when running code. An example of that is the <code>print</code> method in Python; whatever you <code>print</code> is considered an output, and therefore logs.</p><p>Two main concepts in CloudWatch are Log Groups and Log Streams. A log group is a group of log streams that share the same retention period (how long before they get expired and deleted from CloudWatch). In case of Lambda functions, each function is associated with a log group named <code>/aws/lambda/&lt;name-of-the-lambda-function></code>.</p><p>Inside each log group, there are a number of log streams. Each log stream is a sequence of logs that share the same source.</p><h3 id=iam>IAM
<a href=#iam class=h-anchor aria-hidden=true>#</a></h3><p>IAM (or Identity and Access Management) is an AWS service that specifies <em>who</em> or <em>what</em> can access AWS resources. There are a few key concepts when it comes to IAM:</p><ul><li><strong>IAM Identity</strong>: an IAM Identity provides access to an AWS account. Anyone or anything that wants to access AWS services, needs an IAM Identity first</li><li><strong>IAM User</strong>: an IAM Identity who has specific permissions</li><li><strong>IAM Role</strong>: like an IAM User, an IAM Role is also an IAM Identity that has specific permissions. Unlike an IAM User, however, an IAM Role is not uniquely associated with one person. Rather, it can be assumed by anyone or anything that needs it (e.g. an AWS service that wants to access another AWS service)</li><li><strong>IAM Policy</strong>: a document containing one or more permissions to grant or deny access to AWS services</li></ul><p>Examples:</p><ul><li><strong>A person wants to have access to an AWS service.</strong> They first need an IAM Identity. They can create an IAM User for that. Then, they need to attach one or more policies to the IAM User granting access to the appropriate service</li><li><strong>An AWS service, Lambda, wants to have access to another AWS service, CloudWatch, to be able to publish logs.</strong> Lambda needs an IAM Identity first. Since only people can use IAM users, the only choice is an IAM Role. Then, Lambda needs a policy to be attached to the role granting access to publish logs to CloudWatch</li></ul><h3 id=lambda>Lambda
<a href=#lambda class=h-anchor aria-hidden=true>#</a></h3><p>Lambda is the Function As A Service (FaaS) offering from AWS. It&rsquo;s a serverless computing offering that lets you run almost any type of code without the need to provision or maintain a server. Lambda is one of the most popular services on AWS and can be hooked up to more than 200 AWS services (including S3, SQS, SNS, and API Gateway) to build a cloud application. Lambda supports several runtimes (languages), including Python, Nodejs, and Go. You can find the full list <a href=https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html>here</a>.</p><p>As Lambda is serverless and there&rsquo;s no server running at all times, we only pay what we use. For instance, if our code takes 2 seconds to run, we (roughly) only pay for 2 seconds. In a traditional approach, a server would be running 24/7 whether or not it was handling any request or workload.</p><p>Lambda is great, but nothing is perfect. There are a few limitations with Lambda:</p><ul><li>The maximum timeout for the code to run as a Lambda function is 15 minutes. If your code takes more than that to finish, you can&rsquo;t use a Lambda function</li><li>The deployment package (application code + all the dependencies) cannot be over 50MB in a <code>.zip</code> format, and 250MB in an unzipped format. For instance, if you wanted to train a machine learning model, you probably wouldn&rsquo;t be able to do that with a Lambda function. Aside from the fact that most trainings need more than 15 minutes (first limitation), it is very possible that your code plus the libraries you&rsquo;re using (such as tensorflow, keras, pytorch, etc.) will be over 250MB in size</li><li>The maximum memory for a Lambda function is 10GB. If your application is memory intensive and needs more than that, you would be better off with other solutions on AWS, such as AWS Batch</li></ul><p>The most common way to create a deployment package for Lambda is through S3. We create a deployment package (<code>.zip</code> format) and upload it to an S3 bucket. Then, we reference the package S3 address when we create a Lambda function.</p><h3 id=aws-cli>AWS CLI
<a href=#aws-cli class=h-anchor aria-hidden=true>#</a></h3><p>AWS CLI is a command-line tool that provides an easy interface to interact with AWS services. You can find the method of installation that matches your operating system <a href=https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html>here</a>.</p><h3 id=aws-vault>AWS Vault
<a href=#aws-vault class=h-anchor aria-hidden=true>#</a></h3><p>AWS Vault is a command-line tool that provides easy and secure access to AWS credentials in development environments. It&rsquo;s a handy tool that lets us work easily with the AWS SDK and other tools that require AWS credentials, such as Terraform. You can find the installation instructions <a href=https://github.com/99designs/aws-vault>here</a>.</p><h3 id=infrastructure-as-code>Infrastructure as Code
<a href=#infrastructure-as-code class=h-anchor aria-hidden=true>#</a></h3><p>The idea behind infrastructure as code (IaC) is that you write and execute code to define, deploy, update, and destroy your infrastructure. This represents an important shift in mindset in which you treat all aspects of operations as software—even those aspects that represent hardware (e.g., setting up physical servers). In fact, a key insight of DevOps is that you can manage almost everything in code, including servers, databases, networks, log files, application configuration, documentation, automated tests, deployment processes, and so on.</p><p>There are many advantages in using an IaC tool:</p><ul><li>It&rsquo;s repeatable and reusable</li><li>It&rsquo;s easily reversible</li><li>It can be version-controlled</li><li>It can be reviewed and discussed</li><li>It can be automated</li><li>It&rsquo;s a form of documentation out of the box</li></ul><h4 id=popular-iac-tools>Popular IaC Tools
<a href=#popular-iac-tools class=h-anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th>Pulumi</th><th>CloudFormation</th><th>Heat</th><th>Terraform</th></tr></thead><tbody><tr><td><strong>Source</strong></td><td>Open</td><td>Closed</td><td>Open</td><td>Open</td></tr><tr><td><strong>Cloud</strong></td><td>All</td><td>AWS</td><td>All</td><td>All</td></tr><tr><td><strong>Type</strong></td><td>Provisioning</td><td>Provisioning</td><td>Provisioning</td><td>Provisioning</td></tr><tr><td><strong>Infra</strong></td><td>Immutable</td><td>Immutable</td><td>Immutable</td><td>Immutable</td></tr><tr><td><strong>Paradigm</strong></td><td>Declarative</td><td>Declarative</td><td>Declarative</td><td>Declarative</td></tr><tr><td><strong>Master</strong></td><td>No</td><td>No</td><td>No</td><td>No</td></tr><tr><td><strong>Agent</strong></td><td>No</td><td>No</td><td>No</td><td>No</td></tr><tr><td><strong>Paid Service</strong></td><td>Must-have</td><td>N/A</td><td>N/A</td><td>Optional</td></tr><tr><td><strong>Community</strong></td><td>Small</td><td>Small</td><td>Small</td><td>Huge</td></tr><tr><td><strong>Maturity</strong></td><td>Low</td><td>Medium</td><td>Low</td><td>Medium</td></tr></tbody></table><h3 id=terraform>Terraform
<a href=#terraform class=h-anchor aria-hidden=true>#</a></h3><p>Terraform is an open-source Infrastructure As Code (IaC) tool that <em>&ldquo;enables you to safely and predictably create, change, and improve infrastructure&rdquo;</em>. Currently, Terraform is the industry-standard tool when it comes to Infrastructure as Code.</p><p>You can install Terraform on all major operating systems for free. Follow the instructions for your operating system <a href=https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli>here</a>.</p><p>Terraform code is written in the HashiCorp Configuration Language (HCL) in files with the extension <code>.tf</code>. It is a declarative language, so your goal is to describe the infrastructure you want, and Terraform will figure out how to create it.</p><p>Most of the time, we create resource with Terraform. Here&rsquo;s the syntax:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;&lt;PROVIDER&gt;_&lt;TYPE&gt;&#34;</span> <span style=color:#e6db74>&#34;&lt;NAME&gt;&#34;</span> {
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>CONFIG</span> ...]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Where the <code>PROVIDER</code> is the plugin you&rsquo;re using (such as, <code>aws</code>); <code>TYPE</code> is the type of resource you want to create (such as, <code>s3_bucket</code>); <code>NAME</code> is the local name you give to the resource; and <code>CONFIG</code> is the arguments specific to the resource. Here&rsquo;s an example of creating an S3 bucket:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#75715e># create S3 bucket named &#34;test12345678&#34; 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket&#34;</span> <span style=color:#e6db74>&#34;site_bucket&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bucket</span> = <span style=color:#e6db74>&#34;test12345678&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Terraform needs to have access to your AWS credentials. There are several ways to do this. The most common ones are:</p><h4 id=having-your-credentials-as-environment-variables>Having your credentials as environment variables:
<a href=#having-your-credentials-as-environment-variables class=h-anchor aria-hidden=true>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export AWS_ACCESS_KEY_ID<span style=color:#f92672>=</span>xxxxxxx
</span></span><span style=display:flex><span>export AWS_SECRET_ACCESS_KEY<span style=color:#f92672>=</span>xxxxxx
</span></span></code></pre></div><p>Note that this approach only works in your current shell. If you open up a new shell, they&rsquo;ll be gone.</p><h4 id=using-aws-vault>Using AWS Vault
<a href=#using-aws-vault class=h-anchor aria-hidden=true>#</a></h4><p>Another way is to use <code>aws-vault</code> which you installed in the previous step.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws-vault exec &lt;your-aws-vault-profile&gt; -- terraform apply
</span></span></code></pre></div><h4 id=useful-terraform-commands>Useful Terraform Commands
<a href=#useful-terraform-commands class=h-anchor aria-hidden=true>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># see the Terraform version</span>
</span></span><span style=display:flex><span>terraform --version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># initialize a provider or module</span>
</span></span><span style=display:flex><span><span style=color:#75715e># you need to run this every time you add a new provider or module</span>
</span></span><span style=display:flex><span>terraform init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># format code</span>
</span></span><span style=display:flex><span>terraform fmt -recursive .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># validate</span>
</span></span><span style=display:flex><span><span style=color:#75715e># this command will check if the syntax is correct</span>
</span></span><span style=display:flex><span>terraform validate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># plan (what will happen if you apply the code)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># this command will not add/remove/alter any resources</span>
</span></span><span style=display:flex><span><span style=color:#75715e># it&#39;s just for you to see what WILL happen if you apply the code</span>
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># apply</span>
</span></span><span style=display:flex><span><span style=color:#75715e># this will APPLY the code and potentially alter your infrastructure</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Terraform will prompt you once more by default</span>
</span></span><span style=display:flex><span>terraform apply
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># destroy</span>
</span></span><span style=display:flex><span><span style=color:#75715e># this command will destroy all the resources created by Terraform</span>
</span></span><span style=display:flex><span><span style=color:#75715e># in the current configuration files</span>
</span></span><span style=display:flex><span>terraform destroy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># show the list of resources created by Terraform</span>
</span></span><span style=display:flex><span>terraform state list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># show all the outputs</span>
</span></span><span style=display:flex><span>terraform output
</span></span></code></pre></div><hr><h2 id=create-a-lambda-function-with-terraform>Create a Lambda Function with Terraform
<a href=#create-a-lambda-function-with-terraform class=h-anchor aria-hidden=true>#</a></h2><p>As we discussed above, we&rsquo;re going to need an S3 bucket to host our Lambda deployment package. Let&rsquo;s create a bucket with Terraform.</p><h3 id=create-an-s3-bucket>Create an S3 Bucket
<a href=#create-an-s3-bucket class=h-anchor aria-hidden=true>#</a></h3><p>First, we need to set up the <code>terraform</code> block and specify the provider (in this case, AWS). We then specify the region we want to build the infrastructure in.</p><p><code>main.tf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>aws</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;&gt;= 4.0.0&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;hashicorp/aws&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># specify the provider region
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span> = <span style=color:#e6db74>&#34;ca-central-1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, we need to initialize Terraform, since we added a provider:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform init
</span></span></code></pre></div><p>Terraform will install the AWS plugin as part of the initialization.</p><p>Now, we can create our S3 bucket. In the same <code>main.tf</code> file, add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#75715e># S3 bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e># if you omit the name, Terraform will assign a random name to it
</span></span></span><span style=display:flex><span><span style=color:#75715e># see the docs: https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket&#34;</span> <span style=color:#e6db74>&#34;lambda&#34;</span> {}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># output the name of the bucket after creation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;bucket_name&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>aws_s3_bucket</span>.<span style=color:#a6e22e>lambda</span>.<span style=color:#a6e22e>bucket</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can now do <code>aws-vault exec &lt;profile-name> -- terraform plan</code> and then <code>aws-vault exec &lt;profile-name> -- terraform apply</code> to create the bucket. We should be able to see our bucket in the S3 console. If you omitted the bucket name like in the above example, you should see a bucket with a name that starts with <code>terraform</code>.</p><h3 id=application-code>Application Code
<a href=#application-code class=h-anchor aria-hidden=true>#</a></h3><p>We&rsquo;re going to write very simple Python code as this tutorial is not about Python, but rather, about how to run your code as a Lambda function on AWS. Here&rsquo;s our sophisticated code:</p><p><code>main.py</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># the Lambda runtime call a function in our code</span>
</span></span><span style=display:flex><span><span style=color:#75715e># we can name the function anything we want, but it&#39;s a best practice</span>
</span></span><span style=display:flex><span><span style=color:#75715e># to include the word &#34;handler&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># </span>
</span></span><span style=display:flex><span><span style=color:#75715e># the function also needs to accept two positional arguments: event and context.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the Lambda runtime will pass these two arguments when it runs our code.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># we&#39;re not doing anything with them here, but they&#39;re necessary anyway.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handler</span>(event, context):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Hello, Lambda!&#34;</span>)
</span></span></code></pre></div><p>Now, we need to package our code and put it in our S3 bucket we created in the previous step. Here&rsquo;s how we can package our code as a <code>.zip</code> file using the <code>zip</code> tool on Unix-based systems:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># this will zip the `main.py` file and name it `artifact.zip`</span>
</span></span><span style=display:flex><span>zip artifact.zip main.py
</span></span></code></pre></div><p>In case our function has dependencies (external libraries), we need to add them to the deployment package as well. Assuming all the external libraries are listed in the <code>requirements.txt</code> file, here&rsquo;s how we can package them along with the application code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># we create a new folder named &#34;package&#34; and install the dependecies there.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># we then add our application code (files with the &#34;.py&#34; extension) to the </span>
</span></span><span style=display:flex><span><span style=color:#75715e># zip file</span>
</span></span><span style=display:flex><span>mkdir ./package <span style=color:#f92672>&amp;&amp;</span> pip install -r requirements.txt -t ./package
</span></span><span style=display:flex><span>cd package <span style=color:#f92672>&amp;&amp;</span> zip -r9 ../artifact.zip .
</span></span><span style=display:flex><span>cd ../ <span style=color:#f92672>&amp;&amp;</span> zip -g artifact.zip *.py
</span></span></code></pre></div><p>We can now push it to our S3 bucket using the AWS CLI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws s3 cp artifact.zip s3://&lt;name-of-the-bucket&gt;/hello-world/artifact.zip --profile &lt;your-aws-cli-profile&gt;
</span></span></code></pre></div><h3 id=create-a-lambda-function>Create a Lambda Function
<a href=#create-a-lambda-function class=h-anchor aria-hidden=true>#</a></h3><p>Now that the artifact is in S3, we can continue our Terraform code to create our Lambda function. In the same <code>main.tf</code> file, add the following:</p><p><code>main.tf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#75715e># the locals block is used to declare constants that 
</span></span></span><span style=display:flex><span><span style=color:#75715e># you can use throughout your code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>locals</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>function_name</span> = <span style=color:#e6db74>&#34;hello-world&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>handler_name</span>  = <span style=color:#e6db74>&#34;main.handler&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>artifact_name</span> = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>function_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/artifact.zip&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create a role for the Lambda function to assume
</span></span></span><span style=display:flex><span><span style=color:#75715e># every service on AWS that wants to call other AWS services should first assume a role.
</span></span></span><span style=display:flex><span><span style=color:#75715e># then any policy attached to the role will give permissions
</span></span></span><span style=display:flex><span><span style=color:#75715e># to the service so it can interact with other AWS services
</span></span></span><span style=display:flex><span><span style=color:#75715e># see the docs: https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role&#34;</span> <span style=color:#e6db74>&#34;lambda&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>               = <span style=color:#e6db74>&#34;iam-for-lambda-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>function_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>assume_role_policy</span> = <span style=color:#f92672>&lt;&lt;EOF</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;Service&#34;: &#34;lambda.amazonaws.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Sid&#34;: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#f92672>EOF</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create a Lambda function
</span></span></span><span style=display:flex><span><span style=color:#75715e># see the docs: https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_lambda_function&#34;</span> <span style=color:#e6db74>&#34;lambda&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s3_bucket</span>     = <span style=color:#a6e22e>aws_s3_bucket</span>.<span style=color:#a6e22e>lambda</span>.<span style=color:#a6e22e>bucket</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s3_key</span>        = <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>artifact_name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>role</span>          = <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>lambda</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>function_name</span> = <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>function_name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>handler</span>       = <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>handler_name</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # see all available runtimes here: https://docs.aws.amazon.com/lambda/latest/dg/API_CreateFunction.html#SSS-CreateFunction-request-Runtime
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>runtime</span> = <span style=color:#e6db74>&#34;python3.9&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create a policy for publishing logs to CloudWatch
</span></span></span><span style=display:flex><span><span style=color:#75715e># see the docs: https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_policy&#34;</span> <span style=color:#e6db74>&#34;logs&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>        = <span style=color:#e6db74>&#34;lambda-logging-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>function_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;IAM policy for logging from a lambda&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>policy</span> = <span style=color:#f92672>&lt;&lt;EOF</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Action&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;logs:CreateLogGroup&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;logs:CreateLogStream&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;logs:PutLogEvents&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Resource&#34;: &#34;arn:aws:logs:*:*:*&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Effect&#34;: &#34;Allow&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#f92672>EOF</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># attach the above policy to the function role
</span></span></span><span style=display:flex><span><span style=color:#75715e># see the docs: https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role_policy_attachment&#34;</span> <span style=color:#e6db74>&#34;lambda_logs&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>role</span>       = <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>lambda</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>policy_arn</span> = <span style=color:#a6e22e>aws_iam_policy</span>.<span style=color:#a6e22e>logs</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Run <code>aws-vault exec &lt;profile-name> --no-session -- terraform apply</code> to create the Lambda function. You can now head to the Lambda console and test your function. Note the <code>--no-session</code> in the command. This is because AWS doesn&rsquo;t allow creating IAM roles with an assumed role, which is basically what AWS Vault does in the background.</p><p>Here&rsquo;s the final Terraform file:</p><script type=application/javascript src=https://gist.github.com/masoudkarimif/d2c7af419b5dd700ec91a3c8d17ef5a8.js></script><h3 id=cleaning-up>Cleaning Up
<a href=#cleaning-up class=h-anchor aria-hidden=true>#</a></h3><p>Note that this infrastructure doesn&rsquo;t cost you anything if you don&rsquo;t invoke your Lambda function many many times as <em>the AWS Lambda free tier includes one million free requests per month and 400,000 GB-seconds of compute time per month</em>. But if you want to delete all the resources you created, here&rsquo;s how you can do it:</p><h4 id=empty-the-bucket>Empty the Bucket
<a href=#empty-the-bucket class=h-anchor aria-hidden=true>#</a></h4><p>Terraform will not delete your S3 bucket as long as it contains some stuff (in this case, the <code>artifact.zip</code> file). So, you need to empty your bucket first. You can do that using the AWS CLI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws s3 rm --recursive s3://&lt;bucket-name&gt; --profile &lt;profile-name&gt;
</span></span></code></pre></div><p>Now, Terraform can delete all the resources you created with it. Simply run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws-vault exec &lt;profile-name&gt; -- terraform destroy
</span></span></code></pre></div><p>When prompted, answer <code>yes</code> and Terraform will delete everything for you.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://masoudkarimif.github.io/posts/masters-thesis/><span class=button__icon>←</span>
<span class=button__text>My Master's Thesis</span></a></span>
<span class="button next"><a href=https://masoudkarimif.github.io/posts/motivational-stuff/><span class=button__text>Motivational Stuff</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>masoudkf</span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFRSZRJSCV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZFRSZRJSCV",{anonymize_ip:!1})}</script></body></html>